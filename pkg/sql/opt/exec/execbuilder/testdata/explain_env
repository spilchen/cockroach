# LogicTest: local !metamorphic-batch-sizes
# We must turn off metamorphic variables because some are included in
# EXPLAIN (OPT, ENV) output.

statement ok
CREATE TABLE x (
  a INT PRIMARY KEY,
  b INT,
  INDEX (b),
  FAMILY "primary" (a, b)
)

statement ok
ALTER TABLE x INJECT STATISTICS '[
  {
    "columns": ["a"],
    "created_at": "2018-01-01 1:00:00.00000+00:00",
    "row_count": 123123,
    "distinct_count": 100,
    "histo_col_type": ""
  },
  {
    "columns": ["b"],
    "created_at": "2018-01-01 1:00:00.00000+00:00",
    "row_count": 123123,
    "distinct_count": 123123,
    "histo_col_type": ""
  }
]'

statement ok
CREATE TABLE y (
  u INT PRIMARY KEY,
  v INT REFERENCES x,
  INDEX (v),
  FAMILY "primary" (u, v)
)

query T
EXPLAIN (OPT, ENV) SELECT * FROM x WHERE b = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0U-1u2zYU_R0-xYX_2BksRYpRoJARYKrCdNpcOZCUrkUQEBRFrURlMRUpTd4woA_hV9kL7FHyJAOlzHE3ZcE-4h8GeHnuuedcHVoWvOW1ErLyIJDsYy0p-3D-CnjHWdaIMuc1aK40tAMKoQSnkFNNM6o4nMHU3E6XAJYFOS9oU2poadlwDwaoUFp9KuEMZFGMwmijZQ8VVc47UnMmNxte5VQLWSnCK5qVPP8bgj9UBaurJMUxJDhNw-g1qE-lzeo8I6LSvK5oaWtDRWr5I1GaaqG0YMqmisiCaLHp7Vjub7-qcT-W66hHB91jlf1geCqLYpxpb3mMyUhTtoFsqBaMMFmWnJll2A-7mBa0VHycXdcN_zfsG1GZvQwbUmbIi_EBLxznCf5C1pxRpdX_J1ltleYb0n9CRYyBof4PBqCrBPdpXqIgxn6KIfVfrTDcNlkpmN3BDB1RCKP0JUTrFKKr1WqOjrL7ynAK1lGSxn4YpdCR2498C5dx-MaP38N3-D3MKPhJcDxHR2F0jt9BRzIi8g5mWV9Hx0uE_JUxOEw2Yuz9-DD6FgcpJKmfhkkaBglMrxEAwM_9v_lNaPsDUeInPvHAmT-UmSybTaUmHlzviwN-sj_fHOJrTjXPCdUTDyanjvvSclzLccFxPcfxHGdyADaRFhXThMmmMg2uczj7g1BamiARvb01wiaHzVVTlvvGwzbzDPeEpwv3dNHf_TL_r5azZ7HcK3w-1-hmunwqoFsT0OYvAW0fC-h2JKDNlwHdknYIaPt0QLejATW6H-_wz8_hC0UtKYymi3WMw9fRoKk9hhhf4BhHAU7-9CZm1EjC7y5XfhjBbH2ZzgFHb48hwSuj5Su4iNdvoIPvv8ExhgzOYLFElmVZSDFaQff1_RtEcLfb3e0-3-0-A5OV0jUVlfbg5PTE9eD6ZAEWnCxu0O8BAAD__4LDC0Y=


statement error pq: at or near "EOF": syntax error: the ENV flag can only be used with OPT
EXPLAIN (ENV) SELECT * FROM x WHERE b = 3

#
# Multiple Tables.
#

query T
EXPLAIN (OPT, ENV) SELECT * FROM x, y WHERE b = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0VO1u2zYU_R0-xYX_2B4sR4pRoJARYKrDdNpcOZCUrkUQEBRFrVxlMhUpz9owoNgz-OdeYy-wR8mTDJQyx12VBfuIfxjQ5bnnnnN1KMeB17zSQkkfFoq9rxRl785eAN9yltWizHkFhmsDmw6FUIJTyKmhGdUcTmFoT4dzAMeBnBe0Lg1saFlzHzqo0EZ_KOEUVFH0wmhtVAsVMudbUnGm1msuc2qEkppwSbOS539D8KeqxfIySXEMCU7TMHoJ-kM5ZVWeESENryQtp8ZSkUr9QLShRmgjmJ5STVRBjFi3dhzv9990vx_Hc_WDg-6wenpveKiKop9pb7mPyUrTUwtZUyMYYaosObPLmN7vYljQUvN-dlPV_N-wr4W0e-k2pO2QZ_0DnrnuI_yFqjij2uj_T7JutOFr0r5CTayBrv4PBqDLBLdpnqNFjIMUQxq8WGK4qbNSsOkWRuiIQhilzyFapRBdLpcTdJTdVbqnxSpK0jgIoxS25OY9b-AiDl8F8Vv4Br-FEYUgWYwn6CiMzvAb2JKMiHwLo6yto_EcoWBpDXaTrZjpfnwYfY0XKSRpkIZJGi4SGF4hAICf2n_7G9DNd0SLH_nAB3dyX2aqrNdSD3y42hc7_GD_fH2Irzg1PCfUDHwYnLjec8f1HNcD1_Nd13fdwQHYRlpIZghTtbQNnns4-53QRtkgEdPcWGGDw2ZZl-W-8bDNXsM94cnMO5m1Zz9P_qvl7EkstwqfzjW6Hs4fC2hjA1p_FtDNQwFtegJafxrQhmy6gG4eD2jTG1Cr--GO4OwMPlG0IYXVdL6Kcfgy6jRtxhDjcxzjaIGTv9yJEbWS8JuLZRBGMFpdpBPA0esxJHhptXwB5_HqFWwn0MC3X-EYQwanMJsjx3EcJKTklfO9EhJGrFJajxHc7n693X283X0EzaiE5rPK9su7a2tPfrFv53a3uwMwJbWpqJDGh-OTY8-Hq-MZOHA8u0YHsEKUhlcaRva7M0Z_BAAA___1DC9P

#
# Same table twice should only show up once.
#

query T
EXPLAIN (OPT, ENV) SELECT * FROM x one, x two
----
https://cockroachdb.github.io/text/decode.html#eJy0VN1u2zYUvg6f4sA3tgdLkFIUKGzkQlWYQpsrB5JStAgCgqKolatMpiKlyBsG9CFyudfYC-xR8iQDpcxxN2XBfuILwzrnO9_5PvqjHAfe8VoLJZcQKvapVpR9PH0NvOMsb0RV8BoM1wbaAYVQijMoqKE51RxOYGq70xWA40DBS9pUBlpaNXwJA1Rooz9XcAKqLEdhtDGqhwpZ8I7UnKntlsuCGqGkJlzSvOLF3xD8oSpcX6QZTiDFWRbFb0B_rlxWFzkR0vBa0so1lorU6oZoQ43QRjDtUk1USYzY9nYc_7df9bgfx_f0o4vusdp9MDxVZTnOtLc8xmSladdCttQIRpiqKs7sYbgPZzEtaaX5OLupG_5v2LdC2nMZTkjbJS_HF7z0vCf4S1VzRrXR_59kvdOGb0n_F2piDQz1f7AAXaS4T_MKhQkOMgxZ8HqN4brJK8HcDmboiEIUZ68g3mQQX6zXC3SU31eGp3ATp1kSRHEGHbn-xHdwnkRvg-QDfIc_wIxCkIbzBTqK4lP8HjqSE1F0MMv7OpqvEArW1uCw2Ypx9-uj-FscZpBmQRalWRSmML1EAAA_9d_2M6Ht90SLH_lkCd7iocxU1Wylnizhcl8c8JP989UhvubU8IJQM1nC5NjzXzme73g-eP7S85aeNzkA20gLyQxhqpF2wPcOd38U2igbJGJ211bY5HBYNlW1Hzwcs9dwT3j8wj9-0fd-XvxXy_mzWO4VPp9rdDVdPRXQnQ1o85eAto8FdDcS0ObrgO5IOwS0fTqgu9GAWt2PTwSnp_CVopaUVtPZJsHRm3jQ1M4hwWc4wXGI0z_diRm1kvD783UQxTDbnGcLwPG7OaR4bbV8A2fJ5i10EKSgJF8Mv8yNWiHHcRwkpOS184MSEmasVlrPEdzd_nJ3--Xu9gtoRiV0cEn1iZL86pGWuVF96_a-VYrK8FrDzL5V5uj3AAAA__-owyO6

#
# Set a relevant session variable to a non-default value and ensure it shows up
# in the environment dump.
#

statement ok
SET reorder_joins_limit = 63

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0U-1u2zYU_R0-xYX_2BksR4rRIZCRH6rDdNpcOZCUrkUQEBRFrVxlMhUpzdowoA_hV9kL7FHyJAOlwnE3ZcE-4h8GeHnuPeceHToOvOGVFkr6sFTsQ6Uoe3_xEviWs6wWZc4rMFwbaHoUQglOIaeGZlRzOIexvR0vABwHcl7QujTQ0LLmPvRQoY3-WMI5qKIYhNHaqA4qZM63pOJMbTZc5tQIJTXhkmYlz_9mgJJde8VVlfOK_KiE1KQUG2HgHL6eD_ac9YssV9dJimNIcJqG0SvQH8sZq_KMCGl4JWk5M5adVOonog01QhvB9IxqogpixKZzwPF-_00PW-B4rn6U6DNWzx48GquiGJ60d2lokpWmZxayoUYwwlRZcmb9mz3YNy5oqfnwdFPV_N9M3whpfekd0pbkxTDBC9d9Yn6hKs6oNvr_k6xbbfiGdJ9QE7tAX_8HBOg6wd0DWKBljIMUQxq8XGG4q7NSsNkWJuiIQhilZxCtU4iuV6spOso-V_rTch0laRyEUQpbcveBt3AVh6-D-B18h9_BhEKQLI-n6CiMLvBb2JKMiHwLk6yro-MFQsHKLtgzWzGzPX0YfYuXKSRpkIZJGi4TGN8gAIBfun_7G9HmB6LFz3zkgzt9KDNV1hupRz7c7Is9frQ_3x7iK04Nzwk1Ix9Gp6535rie43rger7r-q47OgDbSAvJDGGqlrbBcw-53wttlA0SMe2dFTY6bJZ1We4bD9vsM9wPPJ17p_Pu7tfpf105e5aVO4XPtzW6HS-eCmhrA1r_JaDNYwFtBwJafxnQljR9QJunA9oOBtTqfrwjuLiALxQ1pLCaLtcxDl9FvabmGGJ8iWMcLXHypzcxoVYSfnu1CsIIJuurdAo4enMMCV5ZLV_BZbx-DS18_w2OMdRwDvMFchzHQZpRCS2C-93ufvfpfvcJmJLaVFRI48OJ58PNyRwcOJnfoj8CAAD__wH8GHU=

# Make sure it shows up correctly even if it matches the cluster setting.
statement ok
SET CLUSTER SETTING sql.defaults.reorder_joins_limit = 63


query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0U-1u2zYU_R0-xYX_2BksR4rRIpCRH6rDdNpcOZCUrkUQEBRFrVxlMhUpzdowoA-RV9kL7FHyJAOlwnE3ucE-6h8GdHXuOedenes48JpXWijpw1Kx95Wi7N3FC-BbzrJalDmvwHBtoOlRCCU4hZwamlHN4RzG9u14AeA4kPOC1qWBhpY196GHCm30hxLOQRXFIIzWRnVQIXO-JRVnarPhMqdGKKkJlzQref4FAiW79oqrKucV-UkJqUkpNsLAOTyfD_ac9YMsV9dJimNIcJqG0UvQH8oZq_KMCGl4JWk5M1adVOpnog01QhvB9IxqogpixKbbgOP98bseXoHjufqg0Cesnj3uaKyKYphpt6UvMg3vYPx8Pkx6dpDRDqtnVnRDjWCEqbLkzH6R2eMHGRe01HyY2lQ1_zfsGyHtpvudayvybFjgmes-wV-oijOqjf7_LOtWG74hXSg0sQP09X8ggK4T3J3UAi1jHKQY0uDFCsNdnZWCzbYwQUcUwig9g2idQnS9Wk3RUfap0j8t11GSxkEYpbAld-95C1dx-CqI38L3-C1MKATJ8niKjsLoAr-BLcmIyLcwybo6Ol4gFKzsgL2yNTPbyYfRd3iZQpIGaZik4TKB8Q0CAPi1-7e_EW1-JFr8wkc-uNPHMlNlvZF65MPNrtjjR7vn2318xanhOaFm5MPo1PXOHNdzXA9cz3dd33VHe2B7JEIyQ5iqpW3w3H3td0IbZYNETHtnjY32m2VdlrvG_TZ72DvC07l3Ou_e_Tb9ryNnX2XkzuHXmxrdjhdPBbS1Aa3_FtDmUEDbgYDWnwe0JU0f0ObpgLaDAbW-D3cEFxfwmaOGFNbT5TrG4cuo99QcQ4wvcYyjJU7-chMTai3hN1erIIxgsr5Kp4Cj18eQ4JX18g1cxutX0MIP3-IYQw3nMF8gx3EcpBmV0CJ4uL9_uP_4cP8RmJLaVFRI48OJ58PNyRwcOJnfoj8DAAD__9npMt8=

statement ok
SET enable_zigzag_join = true

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0U91u2zYUvg6f4sA3dgbLkWK0CGTkQnWYTpsrB5LStQgCgqKolKtMpiLlWRkG9CHyKnuBPUqeZKBUOO4mN9hPfGFAR-f7OUffcRx4yystlPRhrtjHSlH24ewV8A1nWS3KnFdguDaw7roQSnAKOTU0o5rDKQzt2-EMwHEg5wWtSwNrWtbch65VaKM_lXAKqih622htVNvKJc1KTu7EzR29IT8rIS1K9oJUUbQYIXO-IRVnarXiMqdGKKlJx5R_Q1TJFl5xVeW8asU0KcVKGDiFl9NezEk3_HxxmaQ4hgSnaRi9Bv2pnLAqz4iQhleSlhPTzlGpX4g21AhtBNMTqokqiBGrdmuO98fvun9tjufqvUJfevXkca9DVRT9TNvNfpOpfwfDl9N-0pO9jHZYPbGiK2oEI0yVJWf2i0weP8iwoKXm_dSmqvm_YV8JaTfd7VxbkRf9Ai9c9wn-QlWcUW30_2dZN9rwFWlDoYkdoKv_AwF0meD2DGdoHuMgxZAGrxYYbuusFGyygRE6oBBG6QlEyxSiy8VijA6yL5Xuab6MkjQOwiiFDbn9yBu4iMM3QfwefsTvYUQhSOaHY3QQRmf4HWxIRkS-gVHW1tHhDKFgYQfslK2ZyVY-jH7A8xSSNEjDJA3nCQyvEADAr-2__Q3o-oZocccHPrjjxzJTZb2SeuDD1bbY9Q-2z9e7_RWnhueEmoEPg2PXO3Fcz3E9cD3fdX3XHew02yMRkhnCVC0twHN3tT8IbZQNEjHNrTU22AXLuiy3wF2YPewt4fHUO562734b_9eRs2cZuXX4fFOj6-HsqYA2NqD13wK63hfQpieg9dcBbci6C-j66YA2vQG1vvcjgrMz-MrRmhTW0_kyxuHrqPO0PoQYn-MYR3Oc_OUmRtRawu8uFkEYwWh5kY4BR28PIcEL6-U7OI-Xb6CBn77HMYYaTmE6Q47jOEgzKqFB8HB__3D_-eH-MzAltamokMaHI8-Hq6MpOHA0vUZ_BgAA__-bDkRc

statement ok
SET optimizer_use_histograms = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0VF1u20YQfjZPMdCL5EKUSQsJDAp-YOR1ylahDJJOExjGYkkunW3IXWd3yYouCuQQvkov0KP4JMWSgay0dIT-WA8COJzvm29mvqFtw1sqFRPcg6XIPkpBsg9nr4BuaJbWrMypBE2VhqbPsqwYJZATTVKiKJzC2LwdLwBsG3JakLrU0JCyph70qUxp9amEUxBFMZhGai26VMpJWlJ8x27uyA3-WTBuUHwQJIqiwzCe0w2WNBNVRXlONBNc4Z4p_0ZRwTu4uNWsYndU4lpR_IEpLW4kqdR-pKRC5lR2MhUuWcU0nMLL-SDmpB_bcnUZJyiCGCVJEL4G9amcZTJPMeOaSk7Kme4mIMUvWGmimdIsUzOisCiwZlU3b9v943c1PHDbddSThb7kqtnjRsaiKIaZtjv5JtPwDMYv58OkJ08ymmbVzBStiGYZzkRZ0szscva4ynFBSkWHqbWs6b9hrxg3k-5nbrY-fjFc4IXj7OEvhKQZUVr9f5JVqzStcGcKhU0DffwfFLAuY9Qd8MJaRshPECT-qxWC2zotWTbbwMQ6IBCEyQmE6wTCy9Vqah2kXyL903IdxknkB2ECG3z7kbZwEQVv_Og9_Ijew4SAHy8Pp9ZBEJ6hd7DBKWb5BiZpF7cOF5blr0yDfWUjZrYtH4Q_oGUCceInQZwEyxjGVxYAwK_dv_mNSHODFbujIw-c6WM4E2VdcTXy4Gob7PNH2-fr3XxJiaY5JnrkwejYcU9sx7UdFxzXcxzPcUY7yeZIGM80zkTNDcB1dmt3XwpjJKzbWyNstAvmdVlugbswc9hbwuO5ezzv3v02_a8tp8_Scqfw-bq2rseLfQZtjUHrvxm0ecqg7YBB668N2uKmN2iz36DtoEGN7qcR_tkZfKWowYXRdL6OUPA67DU1hxChcxShcIniv9zEhBhJ6N3Fyg9CmKwvkimg8O0hxGhltHwH59H6DbTw0_coQlDDKcwXlm3btqUywqG14OH-_uH-88P9Z8gEV1oSxrUHR64HV0dzsOFofm39GQAA__-lbFin

statement ok
SET optimizer_use_multicol_stats = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0VFFu20YQ_TZPMdCP7EKUSQsJDAr-YOR1ylahDJJOExjGYrlcOtssdx3uUhVdFMghfJVeoEfxSYolA1lp6bhpG30I4HDemzczb-i68JrVmisZwELR97Ui9N3pC2AbRvOGi4LVYJg2sO6zHCdFGRTEkJxoBicwtm_HcwDXhYKVpBEG1kQ0LIA-lWujPwg4AVWWg2mkMapLZZLkguFbfn1LrvHPikuLkoMgVZYdhsuCbXDNqKoqJgtiuJIa90zFF4oq2cHVjeEVv2U1bjTD77g26romlf5aZNUIw6kSWBti_gG6ZqouWN01qbHgFTdwAs9ng5jjfuiL5UWaoQRSlGVR_BL0BzGldZFjLg2rJRFT082vVr90Mrg2nOop0ViV2PCq25br__G7Hl6X63v60UKfcvX0YZ9jVZbDTNuNfpFpeAbj57Nh0uNHGbuZT23RihhOMVVCMGqdMH0wwrgkQrNhalM37N-wV1zaSfczt1sfPxsu8MzznuAvVc0o0Ub_f5J1qw2rcGcKjW0DffwrCjgXKerOf-4sEhRmCLLwxRLBTZMLTqcb2Hf2CERxdgzxKoP4YrmcOHv5p0j_tFjFaZaEUZzBBt-8Zy2cJ9GrMHkLP6K3sE8gTBcHE2cvik_RG9jgHPNiA_t5F3cO5o4TLm2DfWUrZrotH8U_oEUGaRZmUZpFixTGlw4AwK_dv_2NyPoaa37LRgF4k4cwVaKppB4FcLkN9vmj7fPVbn7NiGEFJmYUwOjI849dz3c9Hzw_8LzA80Y7yfZIuKQGU9VIC_C93drdd8YaCZv2xgob7YJlI8QWuAuzh70lPJr5R7Pu3W-T_9py_k1a7hR-u66dq_H8KYO21qDN3wy6fsyg7YBBm88N2uJ1b9D10wZtBw1qdT-OCE9P4TNFa1xaTWerBEUv417T-gASdIYSFC9Q-peb2CdWEnpzvgyjGPZX59kEUPz6AFK0tFq-g7Nk9Qpa-Ol7lCBo4ARmc8d1XdfRlEhoHbi_u7u_-3h_9xGoktrUhEsTwKEfwOXhDFw4nF05fwYAAP__58duqA==

statement ok
RESET reorder_joins_limit

statement ok
RESET enable_zigzag_join

statement ok
RESET optimizer_use_histograms

statement ok
RESET optimizer_use_multicol_stats

#
# Test sequences.
#

statement ok
CREATE SEQUENCE seq

query T
EXPLAIN (OPT, ENV) SELECT * FROM seq
----
https://cockroachdb.github.io/text/decode.html#eJysk8-O0zAQxu95irkVEI76h_5hqx5KMKhSm12atNqb5ToTYXBs6nGW5cF4AZ4MuUHsJbsIxC3KfPP7PN_YjMERPWlnryBz6rN3Un18-wbwHtWp1aZCDwEpwF2nSpKCl1DJIE-SEFYwiNXBEoAxqLCWrQlwJ02LV9BJNQU6G1iBq-temWyDu0i1rfBeeFSuadBWMmhnSaCVJ4PVEwBnL-0ena_Qi09OWxJGNzrACmaT3p5FN0i2PRQl30PBy3KTvwc6m1T56iS0DeitNGmI7sK7r4KCDJqCVpRKEq4WQTeXBNjox3fqj4CNhvSo0S8tpQ8ZDVxd95N-p_QkqT-DwWzSD108SozDUhpNGxm0EsoZgypuJH1YyKCWhrAfHXyL_0JvtI1Jd5lTNJn2G0yHwz_wa-dRSQr0_45M3yhgIy6XgkQcoPv_FwbJoeCXJ7VMsj1flxwK_uHA84zDl_ZktEoJz7Db5Mf19sBhBLv1bff5ejyeTObj4WS2mL6az6eL4Rw2ebbnO56XMIKiXO9LGC2ThN_ebNebHJ5d35QvgefH51DwLc9KeAHv9tc7IDwvE8YYSwjPLVqFjDCuIFaSnwEAAP__P3dRzw==

#
# Test views.
#

statement ok
CREATE VIEW v AS SELECT a, b, u, v FROM x, y WHERE b = 3

query T
EXPLAIN (OPT, ENV) SELECT * FROM v
----
https://cockroachdb.github.io/text/decode.html#eJy0VN1u2zYUvg6f4sA3tgfJkWK0CGQEmOqwnTZXDiQlbREEBCVRK1eZTEVKszcMKPYMvtxr7AX2KHmSgVLqOK3SYD_1hQEdnvOd73z8Dm0bLliluBQezGX2rpI0e3v6DNiaZWnNy5xVoJnS0HRZCMU4gZxqmlLF4ASG5nQ4A7BtyFlB61JDQ8uaedClcqXV-xJOQBZFbxqttWxTucjZmlQsk6sVEznVXApFmKBpyfIvAEjRlldMVjmryE-SC0VKvuIaTuDptLfmuBtkvjiPExxBjJMkCF-Ael9OsipPCReaVYKWE226k0r-TJSmmivNMzWhisiCaL5qFbDdv_5U_RLYrqMebHSbqyZ3Gg1lUfQj7VT6IlK_BsOn037Q4wcRzbBqYpquqOYZyWRZsszcyOTuQoYFLRXrh9ZVzf4N-ooLo3SnuTJNnvQ3eOI4j-AXsmIZVVr9f5TVRmm2Iq0pFDEDdPF_0ACdx7hdqRmaR9hPMCT-swWG6zoteTZZwwgdUAjC5BjCZQLh-WJhoYP0NtJ9zZdhnER-ECawJtfv2AbOouClH72BH_AbGFHw4_nYQgdBeIpfw5qkhOdrGKVtHI1nCPkLM2DX2ZCZ7NoH4fd4nkCc-EkQJ8E8huElAgD4tf03vwFtfiSK_8IGHjjWXTiTZb0SauDB5S7Y5Q9231f7-RWjmuWE6oEHgyPHPbYd13ZccFzPcTzHGewlmyXhItMkk7UwBa6z3_stV1oaIxG9uTbEBvvFoi7LXeF-mVnsHeDR1D2atme_Wf915PSrjNwy_HpTo6vh7DGDboxB688M2jxk0E2PQev7Bt2QpjNo87hBN70GNbwfrvBPT-Eeo4YUhtPzZYSDF2HHqRlDhJ_jCIdzHH-yEyM67tPlIsCvPsrStHtrNtVCB7URBI3BjyHGC8OWWpBaUFvQwPNo-fI-vvUJ31ff4QhDCicwnSGEX58t_CCE0fIssQCHF-OPoN90WM0M2bZtIy4Eq2zz9MMoq6RSYwQ32z9uth9uth9AZVTA5rPI-tvb58Gc_G5ccLPd3iZkUihdUS60B4dHh64Hl4dTsOFweoX20gpealYpGJn3bYz-DgAA__8CCndj

#
# Test tables in user-defined schemas.
#

statement ok
CREATE SCHEMA s;
CREATE TABLE s.t (a int primary key)

query T
EXPLAIN (OPT, ENV) SELECT * FROM s.t;
----
https://cockroachdb.github.io/text/decode.html#eJysk8Fu1DAQhs_1U8wtLWqirapWq672kAaDAml2lXgrKoQsbzIRpolNPd7SPhgvwJMhbxC9pEUgrvY_3z_zjx3HcI2OtDUXkNnm1lnVfH59CfiAzXan-xYdeCQP96OKsZoLaJVXW0UIS4jCbbQAiGNosVO73sO96nd4AaNUk6e7HpZgu25Spnbe7qXatPggHTZ2GNC0ymtrSKJR2x7bFwDW7MsdWteik1-sNiR7PWgPSzg_nayZj4NkxaYWvIKaC5GXb4Hu-qRx7VZq49EZ1Sc-uEtnv0nyymvyuqFEkbSd9HrYJxCf_PhO0xHEJzN61uiXlpKnjCLbddOk3ym9SJrOIDo_nYbOnyWGYSkJpoPyupGN7XtswkaSp4VEneoJp9He7fBf6IM2IekxcwomZ9MGZ7PZH_idddgo8vT_WqZH8jjI_aMgGQYYz__CgG1qvv9SC5ZVPBUcRHpZcKDEwyE7UJCXYg7lSkC5KYpjdpCtylpUaV4K8PLrLT7Cusqv0uoG3vMbOFSQ1tkRO1owlhah6xEXHJLAzMt3PBNQi1TktcizGqKPn6IFY_zDukjzEg5Xa3EMvLw-gpoXQfsK3lSrq9DRgsVxHDNqlAHPfgYAAP__2Y1WZQ==

#
# Test default_transaction_quality_of_service settings.
#

statement ok
SET default_transaction_quality_of_service=background

query T
EXPLAIN (OPT, ENV) VALUES(1);
----
https://cockroachdb.github.io/text/decode.html#eJyskkFu2zAQRfc6xewcA6FgI0gQJPAiTYUigOEGtWJ0R4yoUcqGImHOyE12OYSv0gv0KD5JQaloNkqKFt1Sf94XH0cp2FBkG_wFXAfzEAOaL-_fAT2SqTrraoogxAK7IZVl66KEGgUrZIIFTNLXySWAUlBTg50T2KHr6AKG6HCmJaJnNGKD19sOnZUnHRrNFHfWJFCF5uE-hs7Xo7BI953DODAtC28dLCA0zWgaOwl91PqaHnUkE9qWfI2pnzV5rBzVbwCC78cjhVhT1F-D9aydba3AAs5ORmfOBznXy7t1WXyCdVGWN6sPwFuXm1hX2nqh6NHlktp1DN80C4plsYZz5ORDbNtbVfMf33lcq5rP-NWiX1nOXxxNQtOMk35bepM07mBydjIOPX-VmC7LeSptUazRJjhH_UbkLw8yadAxjaMldvQv9Nb6ZHpwzqnkdLzgdDb7A78JkQyy8P_7ZX5ioVb3S8E6XWA4_4uCrPh8u7y6WcHRx9vyGIrVZgqbq-VdsYaj-fQyU0qprB_gDA77_WH_fNg_w9H8eJr9DAAA___03lZf

statement ok
SET default_transaction_quality_of_service=critical

query T
EXPLAIN (OPT, ENV) VALUES(1);
----
https://cockroachdb.github.io/text/decode.html#eJyskkFu2zAQRfc6xexkA6FgI0gQJPAiTYUigOEGtWJ0R4ypUcuWImHOyE12OYSv0gv0KD5JQaloNkqKFt1Sf94XH0cp2FBkG_wl3ATzNQY0n9--AXogs-2sqymCEAvsh1SWrcsKahTcIhMsIE9f8ysApaCmBjsnsEfX0SUM0eFMS0TPaMQGr3cdOiuPOjSaKe6tSSATrViDbhQV6VPnMA5Ey8I7BwsITTOaxk5CH7W-pgcdyYS2JV9jamdNHreO6lcAwffjkUKsKeovwXrWzrZWYAHnp6MzF4Oam-X9uio_wLqsqtvVO-CdK0yst9p6oejRFZLadQzfNAuKZbGGC-RkQ2zbO1XzH995XKqaz_jFol9ZLp4d5aFpxkm_Lb1KGneQn5-OQy9eJKbLcpFKWxRrtAnOUb8PxfOD5A06pnG0xI7-hd5an0wPzjmVnI0XnM1mf-A3IZJBFv5_v8yPLNTqfilYpwsM539RkJUf75bXtyuYvL-rTqBcbaawuV7el2uYzKdXmVJKZf0AZ3A8HI6Hp-PhCSbzk2n2MwAA__-yYVWK

#
# Test recursive table references from foreign keys.
#

statement ok
CREATE TABLE z (
  pk INT PRIMARY KEY,
  ref INT,
  CONSTRAINT fk FOREIGN KEY (ref) REFERENCES y(u),
  FAMILY "primary" (pk, ref)
)

query T
EXPLAIN (OPT, ENV) SELECT * FROM z;
----
https://cockroachdb.github.io/text/decode.html#eJy0U-1um0gU_R2e4sp_bK-MhRO1imzlB3UmFbsujoBUrapqNAxDO-sx48wMrPFqH2tfYJ9sNVA5TgvNfjT-YYnLveecezjXdeEtU5rLYg5LSTdKEvr5-hWwPaNpyUXGFBimDVRtl-PEKIGMGJISzeAKhvbtcAHgupCxnJTCQEVEyebQtrY1bBQpNKGGywLfl0RwU2OZY81UxakFooobTonohFLsUymIahG5NvpewBXIPO_sJqWRTSsvMrbHilG53bIiI5ZdY1aQVLDsOwCyaMYVkypjCv8qeaGx4Ftu4ApeXnTOXLbWLFd3cYIiiFGSBOFr0PdiSlWWYl4YpgoipsayYyV_w9oQw7XhVE-Jtm4Yvm08dWd__am7TXVnnu4l-tKrpw8eDWWedyMdXfouUrcHw5cX3aCXvYh2WT21pFtiOMVUCsGaPEwfPsgwJ0KzbmijSvZf0Le8sE63nmtL8qKb4IXnPYGfS8Uo0Ub_OMm61oZtcRMKje0Cbf1fEDh3MWqOdOEsI-QnCBL_1QrBrkwFp9M9jJwzAkGYXEK4TiC8W60mzln6pdI-LddhnER-ECawx7sNq-E2Ct740Xv4Bb2HEQE_Xo4nzlkQXqN3sMcp5tkeRmlTd8YLx_FXdsGW2YqZHumD8Ge0TCBO_CSIk2AZw_CDAwDwe_NvfwNSfcKaH9hgDt7koUylKLeFHszhw7HY9g-Ozx9P-xUjhmWYmMEcBufe7NL1Zq43A28297y55w1Omu2R8IIaTGVZ2IGZd8r9mWsjbZCwqXdW2OB0uCiFOA6ejtnDPgKeX8zOL5p3f0z-78rps6zcKHy-rZ2Pw8VTAa1tQMtvAlr1BbTuCGj5OKA1rtqAVk8HtO4M6D_QfbC6d5tvhCuW90k_dEjfbZ7WeOjV2L-Vf30Nj1yrcG7Jb9YRCl6HLXk1hgjdoAiFSxR_dbcjMu7HP3yNn28eIyuW92LXMCrtuujd7coPQhitb5MJoPDtGGK0snv-BDfR-g0cFo7ruq6jKSng4PwdAAD__53QiVo=

query T
EXPLAIN (OPT, ENV) SELECT * FROM y;
----
https://cockroachdb.github.io/text/decode.html#eJy0U-1um0gU_R2e4sp_bK-MhRO1imzlB3UmFbsujoBUrapqNAxDO-sx48wMrPFqH2tfYJ9sNVA5TgvNfjT-YYnLveecezjXdeEtU5rLYg5LSTdKEvr5-hWwPaNpyUXGFBimDVRtl-PEKIGMGJISzeAKhvbtcAHgupCxnJTCQEVEyebQtrY1bBQpNKGGywLfl0RwU2OZY81UxakFooobTonohFLsUymIahG5NvpewBXIPO_sJqWRTSsvMrbHilG53bIiI5ZdY1aQVLDsOwCyaMYVkypjCv8qeaGx4Ftu4ApeXnTOXLbWLFd3cYIiiFGSBOFr0PdiSlWWYl4YpgoipsayYyV_w9oQw7XhVE-Jtm4Yvm08dWd__am7TXVnnu4l-tKrpw8eDWWedyMdXfouUrcHw5cX3aCXvYh2WT21pFtiOMVUCsGaPEwfPsgwJ0KzbmijSvZf0Le8sE63nmtL8qKb4IXnPYGfS8Uo0Ub_OMm61oZtcRMKje0Cbf1fEDh3MWqOdOEsI-QnCBL_1QrBrkwFp9M9jJwzAkGYXEK4TiC8W60mzln6pdI-LddhnER-ECawx7sNq-E2Ct740Xv4Bb2HEQE_Xo4nzlkQXqN3sMcp5tkeRmlTd8YLx_FXdsGW2YqZHumD8Ge0TCBO_CSIk2AZw_CDAwDwe_NvfwNSfcKaH9hgDt7koUylKLeFHszhw7HY9g-Ozx9P-xUjhmWYmMEcBufe7NL1Zq43A28297y55w1Omu2R8IIaTGVZ2IGZd8r9mWsjbZCwqXdW2OB0uCiFOA6ejtnDPgKeX8zOL5p3f0z-78rps6zcKHy-rZ2Pw8VTAa1tQMtvAlr1BbTuCGj5OKA1rtqAVk8HtO4M6D_QfbC6d5tvhCuW90k_dEjfbZ7WeOjV2L-Vf30Nj1yrcG7Jb9YRCl6HLXk1hgjdoAiFSxR_dbcjMu7HP3yNn28eIyuW92LXMCrtuujd7coPQhitb5MJoPDtGGK0snv-BDfR-g3UC8d1XdfRlBRQO38HAAD__52_iVg=

query T
EXPLAIN (OPT, ENV) SELECT * FROM x;
----
https://cockroachdb.github.io/text/decode.html#eJy0U-1um0gU_R2e4sp_bK-MhRO1imzlB3UmFbsujoBUrapqNAxDO-sx48wMrPFqH2tfYJ9sNVA5TgvNfjT-YYnLveecezjXdeEtU5rLYg5LSTdKEvr5-hWwPaNpyUXGFBimDVRtl-PEKIGMGJISzeAKhvbtcAHgupCxnJTCQEVEyebQtrY1bBQpNKGGywLfl0RwU2OZY81UxakFooobTonohFLsUymIahG5NvpewBXIPO_sJqWRTSsvMrbHilG53bIiI5ZdY1aQVLDsOwCyaMYVkypjCv8qeaGx4Ftu4ApeXnTOXLbWLFd3cYIiiFGSBOFr0PdiSlWWYl4YpgoipsayYyV_w9oQw7XhVE-Jtm4Yvm08dWd__am7TXVnnu4l-tKrpw8eDWWedyMdXfouUrcHw5cX3aCXvYh2WT21pFtiOMVUCsGaPEwfPsgwJ0KzbmijSvZf0Le8sE63nmtL8qKb4IXnPYGfS8Uo0Ub_OMm61oZtcRMKje0Cbf1fEDh3MWqOdOEsI-QnCBL_1QrBrkwFp9M9jJwzAkGYXEK4TiC8W60mzln6pdI-LddhnER-ECawx7sNq-E2Ct740Xv4Bb2HEQE_Xo4nzlkQXqN3sMcp5tkeRmlTd8YLx_FXdsGW2YqZHumD8Ge0TCBO_CSIk2AZw_CDAwDwe_NvfwNSfcKaH9hgDt7koUylKLeFHszhw7HY9g-Ozx9P-xUjhmWYmMEcBufe7NL1Zq43A28297y55w1Omu2R8IIaTGVZ2IGZd8r9mWsjbZCwqXdW2OB0uCiFOA6ejtnDPgKeX8zOL5p3f0z-78rps6zcKHy-rZ2Pw8VTAa1tQMtvAlr1BbTuCGj5OKA1rtqAVk8HtO4M6D_QfbC6d5tvhCuW90k_dEjfbZ7WeOjV2L-Vf30Nj1yrcG7Jb9YRCl6HLXk1hgjdoAiFSxR_dbcjMu7HP3yNn28eIyuW92LXMCrtuujd7coPQhitb5MJoPDtGGK0snv-BDfR-g3sF47ruq6jKSlg7_wdAAD__52uiVY=

# A foreign key cycle shouldn't cause infinite recursion.
statement ok
ALTER TABLE y ADD CONSTRAINT fk FOREIGN KEY (v) REFERENCES z (pk);

query T
EXPLAIN (OPT, ENV) SELECT * FROM y;
----
https://cockroachdb.github.io/text/decode.html#eJy0U9Fu2zYUfY6-4sIvtgfLkBO0CGzkQXWYQpsrB5JStCgKgqKoljMtOiSlWR72WfuBfdlAqXDcVGrWbfGDAV3de865R-e6LrxlSnNZzGEp6UZJQj9fvwK2ZzQtuciYAsO0gartcpwYJZARQ1KiGVzB0L4dLgBcFzKWk1IYqIgo2Rza1raGjSKFJtRwWeD7kghuaixzrJmqOLVAVHHDKRGdUIp9KgVRLSLXRt8LuAKZ553dpDSyaeVFxvZYMSq3W1ZkxLJrzAqSCpZ9B0AWzbhiUmVM4V8lLzQWfMsNXMHLi86Zy9aa5eouTlAEMUqSIHwN-l5MqcpSzAvDVEHE1Fh2rORvWBtiuDac6inR1g3Dt42n7uyvP3W3qe7M071EX3r19MGjoczzbqSjS99F6vZg-PKiG_SyF9Euq6eWdEsMp5hKIViTh-nDBxnmRGjWDW1Uyf4N-pYX1unWc21JXnQTvPC8J_BzqRgl2uj_T7KutWFb3IRCY7tAW_8BAucuRs2RLpxlhPwEQeK_WiHYlangdLqHkXNGIAiTSwjXCYR3q9XEOUu_VNqn5TqMk8gPwgT2eLdhNdxGwRs_eg-_oPcwIuDHy_HEOQvCa_QO9jjFPNvDKG3qznjhOP7KLtgyWzHTI30Q_oyWCcSJnwRxEixjGH5wAAB-b_7tb0CqT1jzAxvMwZs8lKkU5bbQgzl8OBbb_sHx-eNpv2LEsAwTM5jD4NybXbrezPVm4M3mnjf3vMFJsz0SXlCDqSwLOzDzTrk_c22kDRI29c4KG5wOF6UQx8HTMXvYR8Dzi9n5RfPuj8l_XTl9lpUbhc-3tfNxuHgqoAcb0N3mm4Qqlvdl9NCR0d3m6TAeOsP4DzTWVmP5jcSqT2DdIbD8-ohqXLVHVD2tu-7V3b-pf30NJ4ryDdysIxS8Dls1iuVjiNANilC4RPEjulE57seuH2PbVXK771cMVS_-HkbkR_Afa-9HPtgcWCfRu9uVH4QwWt8mE0Dh2zHEaGUt_AluovUbqBeO67quoykpoHb-DgAA__9YF6Rt

# Check that we remove histograms from statistics correctly.

statement ok
CREATE TABLE b (
  b BOOL NOT NULL,
  INDEX (b)
)

statement ok
ALTER TABLE b INJECT STATISTICS '[
      {
          "avg_size": 1,
          "columns": [
              "b"
          ],
          "created_at": "2022-12-02 18:34:29.574932",
          "distinct_count": 2,
          "histo_buckets": [
              {
                  "distinct_range": 0,
                  "num_eq": 1000,
                  "num_range": 0,
                  "upper_bound": "false"
              },
              {
                  "distinct_range": 0,
                  "num_eq": 100,
                  "num_range": 0,
                  "upper_bound": "true"
              }
          ],
          "histo_col_type": "BOOL",
          "histo_version": 2,
          "name": "__auto__",
          "null_count": 0,
          "row_count": 1100
      },
      {
          "avg_size": 0,
          "columns": [
              "rowid"
          ],
          "created_at": "2022-12-02 18:34:29.574932",
          "distinct_count": 0,
          "histo_col_type": "",
          "name": "__auto__",
          "null_count": 0,
          "row_count": 0
      }
]'

query T
EXPLAIN (OPT, ENV) SELECT * FROM b
----
https://cockroachdb.github.io/text/decode.html#eJy8lN9u2zYUxq_DpzjwjZ3BEmSl6VIbuVAcddCmyoHFBC2KgqAoquVKkQlJpfGGPdZeYE82UGodD1CzP9jmCwP-zne-c_Qj5SCAG26s0GoJa80-Gk3Zh8sL4A-cVZ2QNTfguHVwP7gQKlMMNXW0opbDOUx9dboCCAKoeUM76eCeyo4vYbAOGnGGKkuZE1qRu45K4XZEN8Rycy-YD2JGOMGoHI0y_H0nqRkShXX2TsI56KYZddPO6d4qVM0fiOFMty1XNfXTLeGKVpLXTwRo1bcbrk3NDflRC2WJFK1wcA7PT0Z7zgY06_y6xOkWyhTjrPgO7J0MmakrIpTjRlEZOj-dGP2JWEedsE4wG1LraTjR9kyDxW-_2nGowSKyXx302WvDR0ZT3TTjSXtKTyaNM5g-PxkPPftqon9YG_qhLXWCEaal5P19CB8PZNpQafl4tDMd_yfprVCe9MDc-iGn4wNOo-hP8httOKPW2X9vZbuzjrekvxSW-AcY9L8xAF2Xaf-SrtB6myY4BZxc5CncdpUULKxgho4quNhscig2GIrrPJ-jI6M_iRqyAp_16k1WZr7piwMu05fJdY6hU-Ku69mJenY8R0frTVHibZIVGCpy-5Hv4GqbvUq2b-CH9A3MhtykXHtvVlymr6EiFRH1A8yqXkfHK4SS3PMYFvW7h_tts-L7dI2hxAnOSpytS5i-RQAAP_ff_jOh9--JFT_xyRIW80eZadm1yk6W8HYv9oVqsv_97tBvOHW8JtRNljCJozgOFnEQxbA4W548W8YvwtNvn704iScHPf7VEoo5wnSnfF98UPwgrNP-8hG3u_XbTQ5bFW17jfTnTMgfap2U-8jooOD_KL7oi0UU9ZVf5k8Qif4Kkf6Y_kMq0f9H5TMS9G66Qih9fZUnWQGzzRWeQ1rcHEOZ5v5CfQMvt5tXUK1QEAQBsowqqNDvAQAA__8WlBAF
